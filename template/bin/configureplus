#!/bin/bash

#==============================================================================
#
#         FILE: configureplus
#
#        USAGE: ./configureplus [--verbose] [--global] [--detect-os] <command> [args]
#
#  DESCRIPTION: A minimal autoconf-like configure tool that depends only on bash.
#               It simplifies the process of managing project configurations
#               across different platforms and environments.
#
#      OPTIONS: See 'configureplus usage' for more information
#
# REQUIREMENTS: bash
#         BUGS: Report bugs to https://github.com/muenalan/configureplus/issues
#        NOTES: This is a foundational tool, where development is towards robustness instead of innovation.
#       AUTHOR: Murat Uenalan <murat.uenalan@gmail.com>
# ORGANIZATION: Your Organization Name (if applicable)
#      CREATED: 03/16/2023
#     REVISION: 06/21/2024
#==============================================================================

# Script version
CONFIGUREPLUS_VERSION=0.14.5

# Set script name
SCRIPT_NAME=$(basename "$0")
EXEFILE=`which $0`

# COMMONS ENV
: ${CONFIGUREPLUS_DEBUG:=0}
CONFIGUREPLUS_PWD=$PWD
CONFIGUREPLUS_DIR_OUT=.$SCRIPT_NAME
CONFIGUREPLUS_DIR_OUT_SESSIONS=$CONFIGUREPLUS_DIR_OUT/session
CONFIGUREPLUS_ZERO_ARG_BASENAME=$(basename $0)
CONFIGUREPLUS_DIR_CONFIG=~/.config/$SCRIPT_NAME

CONFIGUREPLUS_OPTION_FLAG_GLOBAL=false
CONFIGUREPLUS_OPTION_FLAG_DETECT_OS=false

# Help function

function configureplus_help_show
{
    echo "Usage: $SCRIPT_NAME [--verbose] [--global] [--detect-os] <command> [options] [args]"
    echo
    echo "Commands:"
    echo "  help <command>        Get help for a specific command"
    echo "  version               Show the version"
    echo "  readme                Show the readme (in markdown format)"
    echo "  man                   Show the manual page (in markdown format)"
    echo "  generate              Update .configureplus; or ~/.config/$SCRIPT_NAME/.$SCRIPT_NAME, if --global is set. (default command)"
    echo "  env                   Show environment variables"
    echo "  set <varname> <value> Set a variable (See doc 'Variable Lookup Order' section)"
    echo "  get <varname>         Get a variable value (See doc 'Variable Lookup Order' section)"
    echo "  status                Show configuration tree"
    echo "  list                  List session paths"
    echo
    echo "Options:"
    echo "  --verbose           Print more information"
    echo "  --global            Operate on global configuration"
    echo "  --detect-os         Detect and save ostype"
    echo
    echo "For more information, use '$SCRIPT_NAME help <command>'"
}

# Check if the script is being sourced
if [[ "${BASH_SOURCE[0]}" != "${0}" ]]; then
    INVOCATION=SOURCED # echo "Script is being sourced"
else
    INVOCATION=RUN # echo "Script is being run"
    # Your main script logic here
fi






# functions

function echo_local
{
   if [ "$CONFIGUREPLUS_DEBUG" -ge "1" ]; then
       >&2 echo "[INFO stdout, $CONFIGUREPLUS_ZERO_ARG_BASENAME] : {" $@ "}"
   fi
}

function warn_local
{
    >&2 echo "[WARN stdout, $CONFIGUREPLUS_ZERO_ARG_BASENAME] : {" $@ "}" 
}

function echo_local_level
{
    local LEVEL=$1

    shift
    
    if [ "$CONFIGUREPLUS_DEBUG" -ge "$LEVEL" ]; then

        echo_local $@

    fi
}

function configureplus_env
{
    warn_local Sourcing ~/.config/$SCRIPT_NAME/$CONFIGUREPLUS_DIR_OUT/global.bash_local
    
    source ~/.config/$SCRIPT_NAME/$CONFIGUREPLUS_DIR_OUT/global.bash_local

    set|perl -ne 'print if /^CONFIGURE(PLUS)?_/;'

    warn_local "Note: Your local shell variables are not shown. Rerun: '$ set|grep CONFIGURE' if needed." 
}

function configureplus_status
{
    warn_local Showing ~/.config/$SCRIPT_NAME/$CONFIGUREPLUS_DIR_OUT/

    tree ~/.config/$SCRIPT_NAME/$CONFIGUREPLUS_DIR_OUT/

    if [ -d "$CONFIGUREPLUS_DIR_OUT/" ]; then

        tree $CONFIGUREPLUS_DIR_OUT/

    fi

    if [[ ! "$CONFIGUREPLUS_DIR_OUT_SESSIONS" ]]; then

	warn_local "CONFIGUREPLUS_DIR_OUT_SESSIONS=$CONFIGUREPLUS_DIR_OUT_SESSIONS is empty"

	return;
    fi

    configureplus_session_identify
    
    if [[ ! "$CONFIGUREPLUS_SESSION" ]]; then

	warn_local "CONFIGUREPLUS_SESSION=$CONFIGUREPLUS_SESSION is empty"

	return;
    fi

    echo ""
    echo "// GLOBAL, LOCAL"

    if [[ -d $CONFIGUREPLUS_DIR_OUT/global ]]; then
	find $CONFIGUREPLUS_DIR_OUT/global/* | perl -MPath::Class -ne 'chomp; $f=file($_); chomp($fs=$f->slurp); printf qq[%s = %s\n], $f, $fs;'
    fi
    
    if [[ -d $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION ]]; then
	find $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/* | perl -MPath::Class -ne 'chomp; $f=file($_); chomp($fs=$f->slurp); printf qq[%s = %s\n], $f, $fs;'
    fi

    echo ""
    echo "// VALUES"

    find $CONFIGUREPLUS_DIR_OUT/global/* $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/* -type f | perl -MPath::Class -MData::Dump=pp -ne 'chomp; $f=file($_); chomp( $val=$f->slurp ); $href->{ $f->basename }->{ /global/ ? "global" : "session" } = $val; END { printf "%-40s %-40s %-40s\n", qw(VARIABLE GLOBAL SESSION); for(sort keys %$href) { printf "%-40s %-40s %-40s\n", $_, $href->{$_}->{global}, $href->{$_}->{session} } }'
    

}

function configureplus_set
{
    if [ -z "$1" ]; then

        echo_local "ARGUMENT_MISSING at pos 1: configureplus_set requires key argument."

    fi
    
    if [ -z "$2" ]; then

        echo_local "ARGUMENT_MISSING at pos 2: configureplus_set requires value argument."

    fi
    
    FNAME=$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/$1

    if [ "$CONFIGUREPLUS_OPTION_FLAG_GLOBAL" = true ]; then

        FNAME=~/.config/$SCRIPT_NAME/$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/$1

    fi

    shift
    
    echo_local Setting $FNAME to value \"$2\" "(all values \"$*\")"

    >$FNAME echo $*
}

function configureplus_get
{
    echo_local Getting $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/$1

    if [ -f $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/$1 ] && [ ! "$CONFIGUREPLUS_OPTION_FLAG_GLOBAL" = true ]; then
        
        FNAME=$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/$1
    
    else

        FNAME=$CONFIGUREPLUS_DIR_CONFIG/$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/$1

        if [ ! -f $FNAME ]; then

            warn_local the global path $FNAME was not available. Now try to global/

            FNAME=$CONFIGUREPLUS_DIR_CONFIG/$CONFIGUREPLUS_DIR_OUT/global/$1

            warn_local Now looking for FNAME=$FNAME

        fi
    fi

    echo_local cat $FNAME

    cat $FNAME

    echo ""
}

function configureplus_sessions_list
{
    warn_local Getting global sessions $CONFIGUREPLUS_DIR_CONFIG/$CONFIGUREPLUS_DIR_OUT/session

    find $CONFIGUREPLUS_DIR_CONFIG/$CONFIGUREPLUS_DIR_OUT/session -maxdepth 1 -mindepth 1 -type d

    if [ -d "$CONFIGUREPLUS_DIR_OUT/" ]; then

        warn_local Getting local sessions $CONFIGUREPLUS_DIR_OUT/session

        find $CONFIGUREPLUS_DIR_OUT -maxdepth 1 -mindepth 1 -type d

    fi

    echo_local Currently CONFIGUREPLUS_SESSION=$CONFIGUREPLUS_SESSION

}

# Example usage:
# configureplus_help "set"

function configureplus_help 
{
    local command="$1"

    case "$command" in
        version)
            echo "Usage: configureplus version"
            echo "Displays the version."
            ;;
        usage)
            echo "Usage: configureplus usage"
            echo "Displays the general usage information for configureplus."
            ;;
        readme)
            echo "Usage: configureplus readme"
            echo "Displays the readme for configureplus in markdown format."
            echo "  Options:"
            echo "   --f|format=markdown           Format"
            ;;
        man)
            echo "Usage: configureplus man"
            echo "Displays the full manual for configureplus in markdown format."
            echo "  Options:"
            echo "   --f|format=markdown           Format"
            ;;
        env)
            echo "Usage: configureplus env"
            echo "Shows all environment variables set by configureplus."
            ;;
        generate)
            echo "Usage: configureplus generate"
            echo "Update the dynamic files from variables. Default folder: .configureplus. If --global is active, ~/.config/$SCRIPT_NAME/.$SCRIPT_NAME"
            echo "  Options:"
            echo "   --f|force           Force overwriting {planned}"
            echo "   --d|dryrun          Dryrun            {planned}"
            ;;
        set)
            echo "Usage: configureplus set <varname> <value>"
            echo "Sets a variable for the current session or globally."
            echo "  <varname>: The name of the variable to set"
            echo "  <value>: The value to assign to the variable"
            echo "  [--global]: Optional. If specified, sets the variable globally"
            ;;
        get)
            echo "Usage: configureplus get <varname>"
            echo "Gets the value of a variable from the current session or globally."
            echo "  <varname>: The name of the variable to get"
            echo "  [--global]: Optional. If specified, gets the global variable"
            ;;
        status)
            echo "Usage: configureplus status"
            echo "Displays the local and global configuration tree structure."
            echo "  Options:"
            echo "   --f|format=filetree             Format (Default: FileTree) {planned}"
            ;;
        list)
            echo "Usage: configureplus list"
            echo "Lists all local and global session paths."
            ;;
        *)
            echo "Unknown command: $command"
            echo "Available commands: usage, man, env, set, get, status, list"
            echo "Use 'configureplus help <command>' for more information on a specific command."
            ;;
    esac
}

function configureplus_readme
{

cat <<'UNTIL_HERE'

# configureplus

Configureplus is a minimal autoconf-like configure tool that depends only on bash. It simplifies the process of managing project configurations across different platforms and environments.

## Features

- Cross-platform configuration management
- Session-based configurations
- Variable management with documentation support
- Multiple output formats (Makefile, Bash, JSON)
- Minimal dependencies (requires only bash)
- Automated configuration file generation
- Flexible and extensible

## Installation

### macOS (darwin19)

```bash
$ make
$ cd build
$ make
$ cd platform/darwin19
$ make install  # for user profile installation
# OR
$ make install-systemwide  # for system-wide installation
```

### Linux (linux-gnu)

```bash
$ make
$ cd build
$ make
$ cd platform/linux-gnu
$ make install  # for user profile installation
# OR
$ make install-systemwide  # for system-wide installation
```

## Usage

Basic usage:

```bash
$ configureplus <command> [args]
```

Available commands:

- `man`: Show the manual page (in markdown format)
- `help <command>`: Get help for a specific command
- `env`: Show environment variables
- `set <varname> <value>`: Set a variable (for the current session or globally)
- `get <varname>`: Get a variable value
- `status`: Show local/global configuration tree
- `list`: List local/global session paths

## Examples

```bash
# Set a variable
$ configureplus set ALPHA 123

# Get a variable
$ configureplus get ALPHA
123

# Create a local session (ostype) CONFIGUREPLUS_SESSION var
$ configureplus get CONFIGUREPLUS_SESSION

# Fetch (create if not exists) a local session 'local1', SESSION var 
$ CONFIGUREPLUS_SESSION=local1 configureplus get CONFIGUREPLUS_SESSION

# Update global session (ostype)
$ configureplus --global
```

## Variable Lookup Order

The `get` function in configureplus searches for variables in a specific order across local, session, and global directories. This allows for flexible configuration management with clear precedence rules.

### Search Order

When you use `configureplus get <varname>`, the tool searches for the variable in the following order:

1. **Local Session**: `$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/<varname>`
   - This is specific to the current working directory and session.

2. **Global Session**: `$CONFIGUREPLUS_DIR_CONFIG/$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/<varname>`
   - This is specific to the current session but applies across all directories.

3. **Global Default**: `$CONFIGUREPLUS_DIR_CONFIG/$CONFIGUREPLUS_DIR_OUT/global/<varname>`
   - This is the fallback for all sessions and directories.

### Example

Let's say you're looking for the variable `ALPHA`:

```bash
$ configureplus get ALPHA
```

The tool will search in this order:

1. `./.configureplus/session/current_session/ALPHA`
2. `~/.config/configureplus/.configureplus/session/current_session/ALPHA`
3. `~/.config/configureplus/.configureplus/global/ALPHA`

It will return the value from the first location where the variable is found. If the variable is not found in any of these locations, it will return an empty result.

### Using the `global` Flag

If you use the `global` flag:

```bash
$ configureplus get ALPHA global
```

The tool will skip the local session search and only look in the global session and global default locations.

### Listing Available Sessions

You can use the `list` command to see all available sessions:

```bash
$ configureplus list
```

This will show you:
- Global sessions in `~/.config/configureplus/.configureplus/session/`
- Local sessions in the current directory's `.configureplus/session/` (if it exists)

Understanding this search order helps you manage your configurations effectively across different scopes and sessions.

## Configuration Files

Configureplus generates several configuration files:

- `.configureplus/global.mk`: Global Makefile include
- `.configureplus/global.bash`: Global Bash script (with exports)
- `.configureplus/global.bash_local`: Global Bash script (without exports)
- `.configureplus/global.json`: Global JSON configuration
- `.configureplus/session/<session-id>.mk`: Session-specific Makefile include
- `.configureplus/session/<session-id>.bash`: Session-specific Bash script (with exports)
- `.configureplus/session/<session-id>.bash_local`: Session-specific Bash script (without exports)
- `.configureplus/session/<session-id>.json`: Session-specific JSON configuration

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## License

[Add your chosen license here]

## Author

Murat Uenalan <murat.uenalan@gmail.com>


    

UNTIL_HERE

}

    
    

function configureplus_man
{

    cat <<UNTIL_HERE

DOCUMENTATION
=============

# configureplus

Minimal autoconfig-like configure tool. Can be used to locally create a (.$SCRIPT_NAME) folder, which holds variables about the platform. Custom variables can be added. 
Moreover, a global fallback for variables is available (~/.config/$SCRIPT_NAME/.$SCRIPT_NAME)

# Synopsis

 $ make install
 $ pushd build/platforms/darwin19
 $ make install-systemwide
 $ configureplus man
 $ cd somewhere
 $ configureplus                                              # create a local .configureplus/ folder with default platform variables (use $OSTYPE)
 $ CONFIGUREPLUS_SESSION=local1 configureplus set ALPHA 123   # set variable ALPHA in session 'local1'
 $ CONFIGUREPLUS_SESSION=local1 configureplus get ALPHA      
 123
 
# Description

Architecture dependency is traditionally detected with an universal **configure** tool. This packages provide similar means, and is not intended to be compatible to the **autoconf** chain. However, it solves a similar generic problem, but beeing more granular and more friendly.

# Aims

- Be universal, with absolute minimal prerequisites: bash.
- Keep it simple. Files are variables, that are used at each step.
- A recorded configuration should be transportable (such as stored in ~/.config for reuse).
- Multiple configurations (sessions) should be able to co-exists. Allowing the switch to a particular **session-key**; testing different versions.

# Supported platforms
This is a multiarch package, where during the build process the platform is detected and a architecture dependant version is manufactured into the platforms directory.

## darwin19 (macos)
There are two alternative installation options. Per default, the program is unpacked into this directory, and the userprofile is modified to include the corresponding bin/ into the PATH system variable.

### INSTALL userprofile (darwin19)

    $ make
      .. building target platform
    $ cd build
    $ make
    $ cd platform/darwin19
    $ make install
      .. installing userprofile

### INSTALL systemwide (darwin19)

    $ make
      .. building target platform
    $ cd build
    $ make
    $ cd platform/darwin19
    $ make install-systemwide
      .. installing systemwide

## linux-gnu
There are two alternative installation options. Per default, the program is unpacked into this directory, and the userprofile is modified to include the corresponding bin/ into the PATH system variable.

### INSTALL userprofile (linux-gnu)

    $ make
      .. building target platform
    $ cd build
    $ make
    $ cd platform/linux-gnu
    $ make install
      .. installing userprofile

### INSTALL systemwide (linux-gnu)

    $ make
      .. building target platform
    $ cd build
    $ make
    $ cd platform/linux-gnu
    $ make install-systemwide
      .. installing systemwide

# SYNOPSIS (darwin19)

    # Warn, because .configureplus/session/darwin19/CONFIGUREPLUS_SESSION is not set
    
    $ configureplus
    [WARN stdout, configureplus] : { ERROR_NOT_SET_CONFIGUREPLUS_SESSION }
    [WARN stdout, configureplus] : { Will invoke: echo darwin19 }
    [WARN stdout, configureplus] : { Retry configureplus again. }    

    $ configureplus
    [WARN stdout, configureplus] : { Loading .configureplus/global/CONFIGUREPLUS_SESSION=darwin19 }
- .configureplus/session/darwin19/CONFIGUREPLUS_DIR_CONFIG = /Users/muenalan/.config/configureplus
- .configureplus/session/darwin19/CONFIGUREPLUS_DIR_OUT = .configureplus
- .configureplus/session/darwin19/CONFIGUREPLUS_DIR_OUT_SESSIONS = .configureplus/session
- .configureplus/session/darwin19/CONFIGUREPLUS_PWD = /Users/muenalan/git-workdirs/github.com/muenalan/bash/configureplus
- .configureplus/session/darwin19/CONFIGUREPLUS_SESSION = 'darwin19' [session-id (such as $OSTYPE)]
- .configureplus/session/darwin19/CONFIGUREPLUS_VERSION = 0.1
- .configureplus/session/darwin19/CONFIGURE_BASH_PROFILE_FILE = /Users/muenalan/.bash_profile
- .configureplus/session/darwin19/CONFIGURE_DIR_OUTPUT = 'platforms' [folder for general and os-specific files (merged with CONFIG_DIR_TEMPLATE)]
- .configureplus/session/darwin19/CONFIGURE_DIR_TEMPLATE = 'template' [folder for os-specific files and template files merged]
- .configureplus/session/darwin19/CONFIGURE_FLAG_TOOL_BTEST = '' [btest *testing* tool path]
- .configureplus/session/darwin19/CONFIGURE_GIT_TAG = v0.0.1
- .configureplus/session/darwin19/CONFIGURE_MKTEMP = '/var/folders/px/ctnmlq5n5gbf154mj25wzdxh0000gn/T/tmp.FU7FWYDy' [make session temp dir]
- .configureplus/session/darwin19/CONFIGURE_OSTYPE = 'darwin19' [current os identifier]
- .configureplus/session/darwin19/CONFIGURE_PKGNAME = 'configureplus' [distribution package name]
- .configureplus/session/darwin19/CONFIGURE_TIMESTAMP = Mon May 22 11:41:16 CEST 2023
- .configureplus/session/darwin19/CONFIGURE_VERSION = '0.0.1'  [distribution version]
    INFO: .configureplus/global.mk generated
    INFO: .configureplus/global.bash generated
    INFO: .configureplus/global.bash_local generated
    INFO: .configureplus/session/darwin19.mk generated
    INFO: .configureplus/session/darwin19.bash generated
    INFO: .configureplus/session/darwin19.bash_local generated

    $ configureplus
    Configuring (darwin19) ...
- .configureplus/session/darwin19/CONFIGUREPLUS_DIR_CONFIG = /Users/muenalan/.config/configureplus
- .configureplus/session/darwin19/CONFIGUREPLUS_DIR_OUT = .configureplus
- .configureplus/session/darwin19/CONFIGUREPLUS_DIR_OUT_SESSIONS = .configureplus/session
- .configureplus/session/darwin19/CONFIGUREPLUS_PWD = /Users/muenalan/git-workdirs/github.com/muenalan/bash/configureplus
- .configureplus/session/darwin19/CONFIGUREPLUS_SESSION = darwin19
- .configureplus/session/darwin19/CONFIGUREPLUS_VERSION = 0.1
- .configureplus/session/darwin19/CONFIGURE_BASH_PROFILE_FILE = /Users/muenalan/.bash_profile
- .configureplus/session/darwin19/CONFIGURE_DIR_OUTPUT = 'platforms' [folder for general and os-specific files (merged with CONFIG_DIR_TEMPLATE)]
- .configureplus/session/darwin19/CONFIGURE_DIR_TEMPLATE = 'template' [folder for os-specific files and template files merged]
- .configureplus/session/darwin19/CONFIGURE_FLAG_TOOL_BTEST = '' [btest *testing* tool path]
- .configureplus/session/darwin19/CONFIGURE_MKTEMP = '/var/folders/px/ctnmlq5n5gbf154mj25wzdxh0000gn/T/tmp.2i0aHmR6' [make session temp dir]
- .configureplus/session/darwin19/CONFIGURE_OSTYPE = 'darwin19' [current os identifier]
- .configureplus/session/darwin19/CONFIGURE_PKGNAME = 'configureplus' [distribution package name]
- .configureplus/session/darwin19/CONFIGURE_TIMESTAMP = Thu May 18 16:54:08 CEST 2023
- .configureplus/session/darwin19/CONFIGURE_VERSION = '0.1'    [distribution version]
- INFO: .configureplus/global.mk generated
- INFO: .configureplus/global.bash generated
- INFO: .configureplus/global.bash_local generated
- INFO: .configureplus/session/darwin19.mk generated
- INFO: .configureplus/session/darwin19.bash generated
- INFO: .configureplus/session/darwin19.bash_local generated
    $ echo value1 .configureplus/global/var1
    $ echo value2 .configureplus/global/var2
    $ echo value3 .configureplus/global/var3
    $ cat .configureplus/dynamic.bash
      >$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/CONFIGURE_BASH_PROFILE_FILE echo $HOME/.bash_profile
      >$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/CONFIGUREPLUS_DIR_CONFIG    echo $HOME/.config/$CONFIGURE_PKG
      >$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/CONFIGURE_OSTYPE            echo $OSTYPE 
      >$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/CONFIGURE_MKTEMP            echo `mktemp -d` 
      >$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/CONFIGURE_FLAG_TOOL_BTEST   which btest
      >$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/CONFIGURE_TIMESTAMP         date
  
# INPUT .configureplus
Files are used to configure the configuration variables.

# SPEC

- .configureplus/global/**VARNAME**                      : global variables, stored as single files
- .confgureplus/**global**.mk                            : global variables single-file (Makefile part)
- .confgureplus/**global**.bash                          : global variables single-file (bash source, export)
- .confgureplus/**global**.bash_local                    : global variables single-file (bash source)
- .configureplus/doc/**VARNAME**                         : variable description, single file
- .confgureplus/session/**session-id**/**VARSESSION-ID** : variable file of session **session-id**
- .confgureplus/session/**session-id**.mk                : session as include'able Makefile part
- .confgureplus/session/**session-id**.bash              : session as include'able bash source (exported variables)
- .confgureplus/session/**session-id**.bash_local        : session as include'able bash source
- .confgureplus/**dynamic**.bash                         : script invoked by configureplus
- .confgureplus/**currentsession**.mk                    : include'able session single-file (Makefile part)
- .confgureplus/**currentsession**.bash                  : include'able session single-file (bash, export)
- .confgureplus/**currentsession**.bash_local            : include'able session single-file (bash)

## .configureplus/**doc**/varname
Each file contains annotation for a single variable. These can be global, or dynamically declared.

- .configureplus/**doc**/CONFIGUREPLUS_SESSIONS
- .configureplus/**doc**/CONFIGURE_MKTEMP
- .configureplus/**doc**/CONFIGURE_DIR_OUTPUT_SESSIONS
- .configureplus/**doc**/CONFIGURE_DIR_OUTPUT
- .configureplus/**doc**/CONFIGURE_FLAG_TOOL_BTEST
- .configureplus/**doc**/CONFIGURE_OSTYPE
- .configureplus/**doc**/CONFIGURE_PKGNAME
- .configureplus/**doc**/CONFIGURE_DIR_TEMPLATE
- .configureplus/**doc**/CONFIGURE_VERSION


# EXAMPLE

- .configureplus
- .configureplus/Makefile
- .configureplus/**dynamic.bash**
- .configureplus/**global**
- .configureplus/**global**/CONFIGUREPLUS_SESSION                         # variable
- .configureplus/**global**/CONFIGURE_DIR_OUTPUT                          # variable
- .configureplus/**global**/CONFIGURE_PKGNAME                             # variable
- .configureplus/**global**/CONFIGURE_DIR_TEMPLATE                        # variable
- .configureplus/**global**/CONFIGURE_VERSION                             # variable
- .configureplus/**global.bash_local**
- .configureplus/**global.bash**
- .configureplus/**global.mk**
- .configureplus/**doc**
- .configureplus/**doc**/CONFIGUREPLUS_SESSIONS
- .configureplus/**doc**/CONFIGURE_MKTEMP
- .configureplus/**doc**/CONFIGURE_DIR_OUTPUT_SESSIONS
- .configureplus/**doc**/CONFIGURE_DIR_OUTPUT
- .configureplus/**doc**/CONFIGURE_FLAG_TOOL_BTEST
- .configureplus/**doc**/CONFIGURE_OSTYPE
- .configureplus/**doc**/CONFIGURE_PKGNAME
- .configureplus/**doc**/CONFIGURE_DIR_TEMPLATE
- .configureplus/**doc**/CONFIGURE_VERSION
- .configureplus/**session**
- .configureplus/**session**/darwin19
- .configureplus/**session**/darwin19/CONFIGUREPLUS_DIR_OUT               # variable
- .configureplus/**session**/darwin19/CONFIGUREPLUS_SESSION               # variable
- .configureplus/**session**/darwin19/CONFIGUREPLUS_PWD                   # variable
- .configureplus/**session**/darwin19/CONFIGUREPLUS_DIR_CONFIG            # variable
- .configureplus/**session**/darwin19/CONFIGUREPLUS_VERSION               # variable
- .configureplus/**session**/darwin19/CONFIGUREPLUS_DIR_OUT_SESSIONS      # variable
- .configureplus/**session**/darwin19/CONFIGURE_MKTEMP                    # variable
- .configureplus/**session**/darwin19/CONFIGURE_TIMESTAMP                 # variable
- .configureplus/**session**/darwin19/CONFIGURE_DIR_OUTPUT                # variable
- .configureplus/**session**/darwin19/CONFIGURE_FLAG_TOOL_BTEST           # variable
- .configureplus/**session**/darwin19/CONFIGURE_OSTYPE                    # variable
- .configureplus/**session**/darwin19/CONFIGURE_PKGNAME                   # variable
- .configureplus/**session**/darwin19/CONFIGURE_DIR_TEMPLATE              # variable
- .configureplus/**session**/darwin19/CONFIGURE_BASH_PROFILE_FILE         # variable
- .configureplus/**session**/darwin19/CONFIGURE_VERSION                   # variable
- .configureplus/**session**/darwin19.bash_local
- .configureplus/**session**/darwin19.bash
- .configureplus/**session**/darwin19.mk
- .configureplus/**currentsession.bash**
- .configureplus/**currentsession.mk**

# Author

Murat Uenalan <murat.uenalan@gmail.com>

UNTIL_HERE

    exit
}



# defaults

function configureplus_dir_config_setup
{

    if [ ! -d "$CONFIGUREPLUS_DIR_CONFIG" ]; then

        export CONFIGUREPLUS_DIR_CONFIG_EMPTY=1

        warn_local "init $CONFIGUREPLUS_DIR_CONFIG"

        mkdir -p $CONFIGUREPLUS_DIR_CONFIG
        
    fi
}

function configureplus_session_var_update_ostype
{
    echo $OSTYPE >$CONFIGUREPLUS_DIR_OUT/global/CONFIGUREPLUS_SESSION

    warn_local "--detect-os: \$OSTYPE >$CONFIGUREPLUS_DIR_OUT/global/CONFIGUREPLUS_SESSION"
}

function configureplus_session_identify
{
    echo_local_level 2 configureplus_session_identify ..
    
if [[ -z "$CONFIGUREPLUS_SESSION" ]]; then

    echo_local CONFIGUREPLUS_SESSION not set at start.

    if [ -f "$CONFIGUREPLUS_DIR_OUT/global/CONFIGUREPLUS_SESSION" ]; then

	CONFIGUREPLUS_SESSION=$(cat $CONFIGUREPLUS_DIR_OUT/global/CONFIGUREPLUS_SESSION)
	
	echo_local Setting to $CONFIGUREPLUS_SESSION "(from $CONFIGUREPLUS_DIR_OUT/global/CONFIGUREPLUS_SESSION)"
	
    else

        if [ "$CONFIGUREPLUS_DIR_OUT" == `basename $PWD` ]; then

            warn_local "init $CONFIGUREPLUS_DIR_OUT ... *SKIP* because we are currently inside one."

            exit
        fi

	CONFIGUREPLUS_DEBUG=1 warn_local ERROR_NOT_SET_CONFIGUREPLUS_SESSION
	
	warn_local Will invoke: mkdir -p $CONFIGUREPLUS_DIR_OUT/global

        mkdir -p $CONFIGUREPLUS_DIR_OUT/global

	warn_local Will invoke: echo $OSTYPE >$CONFIGUREPLUS_DIR_OUT/global/CONFIGUREPLUS_SESSION

	echo $OSTYPE >$CONFIGUREPLUS_DIR_OUT/global/CONFIGUREPLUS_SESSION

	warn_local Retry configureplus again.

	exit
    fi

fi

    echo_local_level 2 configureplus_session_identify .. done

}




function configureplus_session_directory_setup
{
    echo_local_level 2 configureplus_session_directory_setup ..

# $CONFIGUREPLUS_SESSION

mkdir -p $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION

# dynamic

if [ ! -f $CONFIGUREPLUS_DIR_OUT/dynamic.bash ]; then

    warn_local Probing $CONFIGUREPLUS_DIR_CONFIG/$CONFIGUREPLUS_DIR_OUT/dynamic.bash
    
    if [ -f $CONFIGUREPLUS_DIR_CONFIG/$CONFIGUREPLUS_DIR_OUT/dynamic.bash ]; then

        warn_local cp $CONFIGUREPLUS_DIR_CONFIG/$CONFIGUREPLUS_DIR_OUT/dynamic.bash $CONFIGUREPLUS_DIR_OUT/

        cp $CONFIGUREPLUS_DIR_CONFIG/$CONFIGUREPLUS_DIR_OUT/dynamic.bash $CONFIGUREPLUS_DIR_OUT/

    else

        warn_local touch $CONFIGUREPLUS_DIR_OUT/dynamic.bash

        touch $CONFIGUREPLUS_DIR_OUT/dynamic.bash

    fi
    

fi


if [ ! -d $CONFIGUREPLUS_DIR_OUT/global ]; then

    mkdir -p $CONFIGUREPLUS_DIR_OUT/global 

fi

    echo_local_level 2 configureplus_session_directory_setup .. done

}

function configureplus_dynamic_source
{
    echo_local_level 2 configureplus_dynamic_source ..

    echo_local source $CONFIGUREPLUS_DIR_OUT/dynamic.bash

    source $CONFIGUREPLUS_DIR_OUT/dynamic.bash

    echo_local_level 2 configureplus_dynamic_source .. end
}

function configureplus_globalvars_setup
{
    echo_local_level 2 configureplus_globalvars_setup .. 

    # global

    echo_local "configureplus_globalvars_setup .. init session vars from global (overwrite) (source=$CONFIGUREPLUS_DIR_OUT/global/)"

    for VARFILE in $CONFIGUREPLUS_DIR_OUT/global/*; do

	BASENAME=$(basename $VARFILE)

	if [ ! -f "$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/$BASENAME" ]; then
	    
	    warn_local .. overwriting "$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/$VARFILE"

            cp $VARFILE $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/
	
	fi

    done

    # std

    echo_local_level 2 configureplus_globalvars_setup .. write current variable values to $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/

    VARS="PWD SESSION VERSION DIR_CONFIG DIR_OUT DIR_OUT_SESSIONS"

    echo_local .. reset VARS=$VARS

    for VARNAME in $VARS; do

	VARNAME_=CONFIGUREPLUS_$VARNAME

	VARNAME_FULL=$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/$VARNAME_

	if [ ! -f "$VARNAME_FULL" ]; then
	    
	    echo_local .. overwrite $VARNAME_FULL = ${!VARNAME_}

	    >$VARNAME_FULL               echo ${!VARNAME_}

	fi
	
    done

    echo_local_level 2 configureplus_globalvars_setup .. done
}


# functions

function configureplus_summary
{
    echo_local PWD=$PWD
    
    echo_local_level 2 configureplus_summary "(find $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/*|sort)":

    for VARFILE in $(find $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/*|sort); do

	BASENAME=$(basename $VARFILE)

	DOCFILE=$CONFIGUREPLUS_DIR_OUT/doc/$BASENAME

	DOCFILE_GLOBAL=~/.config/configureplus/.configureplus/doc/$BASENAME

#	echo_local DOCFILE=$DOCFILE

#	echo_local DOCFILE_GLOBAL=$DOCFILE_GLOBAL

	DOCFILE=$DOCFILE_GLOBAL
	
	if [ -f $DOCFILE ]; then

	    >&2 printf "     - %-90s [%s]\n" "$VARFILE = '$(cat $VARFILE)'" "$(cat $DOCFILE)" 

	else

    	    >&2 echo   "     - $VARFILE = "`cat $VARFILE`
	fi

    done
}


# mk

function configureplus_generate_configure_global_mk
{
    echo >$CONFIGUREPLUS_DIR_OUT/global.mk

    echo "# Generated with configureplus (CONFIGUREPLUS_VERSION=$CONFIGUREPLUS_VERSION, CONFIGUREPLUS_PWD=$CONFIGUREPLUS_PWD)" >>$CONFIGUREPLUS_DIR_OUT/global.mk
    echo "# Note: space before a comment are part of a variable" >>$CONFIGUREPLUS_DIR_OUT/global.mk

    echo >>$CONFIGUREPLUS_DIR_OUT/global.mk

    for VARFILE in $CONFIGUREPLUS_DIR_OUT/global/*; do

	BASENAME=$(basename $VARFILE)

	DOCFILE=$CONFIGUREPLUS_DIR_OUT/doc/$BASENAME

	if [ -f $DOCFILE ]; then

	    printf "%s# %s\n" "$BASENAME=\$(shell cat $VARFILE)" "$(cat $DOCFILE)" >>$CONFIGUREPLUS_DIR_OUT/global.mk

	else

	    echo "$BASENAME=\$(shell cat $VARFILE)" >>$CONFIGUREPLUS_DIR_OUT/global.mk
	fi

    done

    echo "   " $CONFIGUREPLUS_DIR_OUT/global.mk generated
}

function configureplus_generate_configure_session_mk
{
    echo >$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.mk

    echo "# Generated with configureplus (CONFIGUREPLUS_VERSION=$CONFIGUREPLUS_VERSION, CONFIGUREPLUS_PWD=$CONFIGUREPLUS_PWD)" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.mk
    echo "# Note: space before a comment are part of a variable" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.mk

    echo >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.mk

    for VARFILE in $(find $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/*|sort); do

	BASENAME=$(basename $VARFILE)

	DOCFILE=$CONFIGUREPLUS_DIR_OUT/doc/$BASENAME

	if [ -f $DOCFILE ]; then

	    printf "%s# %s\n" "$BASENAME=\$(shell cat $VARFILE)" "$(cat $DOCFILE)" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.mk

	else

	    echo "$BASENAME=\$(shell cat $VARFILE)" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.mk
	fi

    done

    echo "   " $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.mk generated
}

function configureplus_generate_configure_global_bash
{
    echo >$CONFIGUREPLUS_DIR_OUT/global.bash

    echo "# Generated with configureplus (CONFIGUREPLUS_VERSION=$CONFIGUREPLUS_VERSION, CONFIGUREPLUS_PWD=$CONFIGUREPLUS_PWD)" >>$CONFIGUREPLUS_DIR_OUT/global.bash

    echo >>$CONFIGUREPLUS_DIR_OUT/global.bash

    for VARFILE in $CONFIGUREPLUS_DIR_OUT/global/*; do

	BASENAME=$(basename $VARFILE)

	DOCFILE=$CONFIGUREPLUS_DIR_OUT/doc/$BASENAME

	if [ -f $DOCFILE ]; then

	    printf "export %-85s # %s\n" "$BASENAME='$(cat $VARFILE)'" "$(cat $DOCFILE)" >>$CONFIGUREPLUS_DIR_OUT/global.bash

	else

	    printf "export %s\n" "$BASENAME='$(cat $VARFILE)'" >>$CONFIGUREPLUS_DIR_OUT/global.bash
	fi

    done

    echo "   " $CONFIGUREPLUS_DIR_OUT/global.bash generated
}



function configureplus_generate_configure_global_bash_local
{
    echo >$CONFIGUREPLUS_DIR_OUT/global.bash_local

    echo "# Generated with configureplus (CONFIGUREPLUS_VERSION=$CONFIGUREPLUS_VERSION, CONFIGUREPLUS_PWD=$CONFIGUREPLUS_PWD)" >>$CONFIGUREPLUS_DIR_OUT/global.bash_local

    echo >>$CONFIGUREPLUS_DIR_OUT/global.bash_local

    for VARFILE in $CONFIGUREPLUS_DIR_OUT/global/*; do

	BASENAME=$(basename $VARFILE)

	DOCFILE=$CONFIGUREPLUS_DIR_OUT/doc/$BASENAME

	if [ -f $DOCFILE ]; then

	    printf "%-85s # %s\n" "$BASENAME='$(cat $VARFILE)'" "$(cat $DOCFILE)" >>$CONFIGUREPLUS_DIR_OUT/global.bash_local

	else

	    printf "%s\n" "$BASENAME='$(cat $VARFILE)'" >>$CONFIGUREPLUS_DIR_OUT/global.bash_local
	fi

    done

    echo "   " $CONFIGUREPLUS_DIR_OUT/global.bash_local generated
}

function configureplus_generate_configure_global_json
{
    echo >$CONFIGUREPLUS_DIR_OUT/global.json

    # JSON does not support comments
    #    echo "# Generated with configureplus (CONFIGUREPLUS_VERSION=$CONFIGUREPLUS_VERSION, CONFIGUREPLUS_PWD=$CONFIGUREPLUS_PWD)" >>$CONFIGUREPLUS_DIR_OUT/global.json

    echo "[" >>$CONFIGUREPLUS_DIR_OUT/global.json

    echo >>$CONFIGUREPLUS_DIR_OUT/global.json


    local ARRAY=($CONFIGUREPLUS_DIR_OUT/global/*)

    local ARRAY_LEN=${#ARRAY[@]}

    local CNT=1

    for VARFILE in ${ARRAY[@]}; do

	local BASENAME=$(basename $VARFILE)

        COMMA=

        if [[ $CNT < $ARRAY_LEN ]]; then

            COMMA=,
            
        fi

	printf -v VAR '   "%s" : "%s"%s'  $BASENAME "$(cat $VARFILE)" $COMMA

        echo "$VAR"  >>$CONFIGUREPLUS_DIR_OUT/global.json

	let CNT=$CNT+1
        
    done

    echo >>$CONFIGUREPLUS_DIR_OUT/global.json

    echo "]" >>$CONFIGUREPLUS_DIR_OUT/global.json

    echo "   " $CONFIGUREPLUS_DIR_OUT/global.json generated
}





# session

function configureplus_generate_configure_session_bash
{
    echo >$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash

    echo "# Generated with configureplus (CONFIGUREPLUS_VERSION=$CONFIGUREPLUS_VERSION, CONFIGUREPLUS_PWD=$CONFIGUREPLUS_PWD)" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash

    echo >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash

    for VARFILE in $(find $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/*|sort); do

	BASENAME=$(basename $VARFILE)

	DOCFILE=$CONFIGUREPLUS_DIR_OUT/doc/$BASENAME

	if [ -f $DOCFILE ]; then

	    printf "export %-85s # %s\n" "$BASENAME='$(cat $VARFILE)'" "$(cat $DOCFILE)" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash

	else

	    printf "export %s\n" "$BASENAME='$(cat $VARFILE)'" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash
	fi
        
    done

    echo "   " $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash generated
}

function configureplus_generate_configure_session_bash_local
{
    echo >$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash_local

    echo "# Generated with configureplus (CONFIGUREPLUS_VERSION=$CONFIGUREPLUS_VERSION, CONFIGUREPLUS_PWD=$CONFIGUREPLUS_PWD)" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash_local

    echo >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash_local

    for VARFILE in $(find $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/*|sort); do

	BASENAME=$(basename $VARFILE)

	DOCFILE=$CONFIGUREPLUS_DIR_OUT/doc/$BASENAME

        #echo_local $VARFILE .... ENTRY

	if [ -f $DOCFILE ]; then

	    printf "%-85s # %s\n" "$BASENAME='$(cat $VARFILE)'" "$(cat $DOCFILE)" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash_local

	else

	    printf "%s\n" "$BASENAME='$(cat $VARFILE)'" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash_local
	fi

    done

    echo "   " $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.bash_local generated
}

function configureplus_generate_configure_session_json
{
    echo >$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.json

    echo "[" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.json

    echo >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.json

    local ARRAY=($(echo $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION/*|sort))

    local ARRAY_LEN=${#ARRAY[@]}

    local CNT=1

    for VARFILE in ${ARRAY[@]}; do

	BASENAME=$(basename $VARFILE)

        COMMA=

        #        echo CNT=$CNT ARRAY_LEN=$ARRAY_LEN
        
        if [[ $CNT -lt $ARRAY_LEN ]]; then

            COMMA=,
            
        fi

	printf -v VAR '   "%s" : "%s"%s'  $BASENAME "$(cat $VARFILE)" $COMMA

        echo "$VAR"  >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.json

	let CNT=$CNT+1

    done

    echo >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.json

    echo "]" >>$CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.json

    echo "   " $CONFIGUREPLUS_DIR_OUT_SESSIONS/$CONFIGUREPLUS_SESSION.json generated
}

# main

function configureplus_generate 
{
    echo_local_level 2 configureplus_generate ..

    local target_dir="$CONFIGUREPLUS_DIR_OUT"

    if [ "$CONFIGUREPLUS_OPTION_FLAG_GLOBAL" = true ]; then

        target_dir="$CONFIGUREPLUS_DIR_CONFIG/"

        cd $target_dir

        echo_local Detected CONFIGUREPLUS_OPTION_FLAG_GLOBAL, switched to PWD=$PWD

    fi

    echo_local_level 2 configureplus_generate show summary..
    
    configureplus_summary
    
    echo "Generating configuration in $target_dir"

    # Call your existing generation functions here
    configureplus_generate_configure_global_mk
    configureplus_generate_configure_global_bash
    configureplus_generate_configure_global_bash_local
    configureplus_generate_configure_global_json
    configureplus_generate_configure_session_mk
    configureplus_generate_configure_session_bash
    configureplus_generate_configure_session_bash_local
    configureplus_generate_configure_session_json

    echo_local_level 2 configureplus_generate .. done

    echo "Configuration generated successfully"
}




function configureplus_setup
{
    echo_local_level 2 configureplus_setup ..
    
    configureplus_dir_config_setup

    configureplus_session_identify

    configureplus_session_directory_setup

    configureplus_dynamic_source

    configureplus_globalvars_setup

    echo_local_level 2 configureplus_setup .. done
}

# Main script logic

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then

    # Note that we use `"$@"' to let each command-line parameter expand to a 
    # separate word. The quotes around `$@' are essential!
    # We need TEMP as the `eval set --' would nuke the return value of getopt.

    GETOPT_RESULTS=`getopt -o dgon:c:: --long debug,global,detect-os,name:,c-long:: -n $SCRIPT_NAME -- "$@"`

    if [ $? != 0 ] ; then
        
        echo "*FATAL* getopt invokation failed. Terminating..." >&2
        
        exit 1 
    fi

    # Note the quotes around `$GETOPT_RESULTS': they are essential!

    echo_local_level 2 getopt RESULTS: "$GETOPT_RESULTS"
    
    eval set -- "$GETOPT_RESULTS"

    while true ; do
        case "$1" in
            -d|--debug) 
	        warn_local "Option d" 
                CONFIGUREPLUS_DEBUG=$0
	        shift 
	        ;;
            -g|--global) 
	        warn_local "Option g"
	        shift 
                CONFIGUREPLUS_OPTION_FLAG_GLOBAL=true
	        ;;
            -o|--detect-os) 
	        warn_local "Option o"
                CONFIGUREPLUS_OPTION_FLAG_DETECT_OS=true                
                configureplus_setup
                configureplus_session_var_update_ostype
	        shift 
	        ;;
            -n|--name) 
	        warn_local "Option n, argument \`$2'" ; 
	        shift 2 
	        ;;
            -c|--c-long) 
                # c has an optional argument. As we are in quoted mode,
                # an empty parameter will be generated if its optional
                # argument is not found.
                case "$2" in
                    "") 
		        warn_local "Option c, no argument"
		        shift 2 
		        ;;
                    *)  
		        warn_local "Option c, argument \`$2'"
		        shift 2 
		        ;;
                esac 
	        ;;
            --) 
	        shift 
	        break 
	        ;;
            *) 
	        echo "Internal error!" 
	        exit 1 
	        ;;
        esac
    done

    echo_local "Remaining getopt arguments:"

    for arg;
    do 
        echo_local '    - ARG:  '"\`$arg'" ; 
    done








    # Default command is now 'generate'
    COMMAND=${1:-generate}

    case "$COMMAND" in
        generate)
            configureplus_setup
            configureplus_generate
            ;;
        version)
            echo $CONFIGUREPLUS_VERSION
            exit 0
            ;;
        readme)
            # Your existing readme commmed logic
            configureplus_readme
            ;;
        man)
            # Your existing man command logic
            configureplus_man
            ;;
        help)
            # Your existing help command logic
            if [[ -z "$2" ]]; then
	        
                configureplus_help_show
                
            else
	        
                configureplus_help "$2"
                
            fi
            ;;
        env)
            # Your existing env command logic
            configureplus_env
            ;;
        set)
            # Your existing set command logic
            configureplus_setup
            configureplus_set $2 $3 $4
            ;;
        get)
            # Your existing get command logic
            configureplus_setup
            configureplus_get $2 $3
            ;;
        status)
            # Your existing status command logic
            #configureplus_setup
            configureplus_status
	    exit 0
            ;;
        list)
            # Your existing list command logic
            configureplus_setup
            configureplus_sessions_list
            ;;
        *)
            echo "Unknown command: $COMMAND"
            configureplus_help_show
            exit 1
            ;;
    esac
else
    echo "Script is being sourced"
fi




function join_array_comma
{
    local SEP=$1

    shift
    
    local ARRAY=$@
    
    ARRAY_LEN=${#ARRAY[@]}

#    echo ARRAY="${ARRAY[@]} .."
    
#    echo ARRAY_LEN=$ARRAY_LEN

    CNT=1

    RESULT=()

    for ENTRY in ${ARRAY[@]}; do

        COMMA=

        if [[ $CNT -lt $ARRAY_LEN ]]; then

            COMMA=,
            
        fi

	printf -v VAR '%s%s' $ENTRY $COMMA

        echo "VAR=$VAR"
        
        RESULT=("${RESULT[@]}" $VAR)
                
	let CNT=$CNT+1

    done

    echo ${RESULT[@]}
}

#test
#join_array_comma ",\n" "ALPHA : 1" "BETA : 2" "GAMMA : 3"

